<html>
	<head>
		<title>Pixel Fireplace</title>
		<style>
            * { border: 0; margin: 0; }
		</style>
		<script src="jquery-2.0.3.min.js"></script>
		<script src="processing-1.4.1.min.js"></script>
		<script>
			$(function() {
				var canvas = $("#fire").first()[0]
				canvas.width = window.innerWidth;
				canvas.height = window.innerHeight;

				var sketch = new Processing.Sketch();
				sketch.attachFunction = function(p) {
					p.setup = function() {
						p.size(canvas.width, canvas.height);

						// Use this to limit tearing and make it more "pixely"
						p.frameRate(15);
						p.pixelSize = 20;
						p.perlinTimer = 0;
            p.emberTimer = 0;

						p.embers = [];

						p.resize();
					}

					p.draw = function() {
						p.resize();
						p.updateFire();
						p.background(0);

						var w = canvas.width;
						var h = canvas.height;

						var x = (w - p.fire[0].length * p.pixelSize) / 2;

						var x1 = p.fire[0].length / 2;
						var y1 = 2;

						var maxDist = Math.sqrt(Math.pow(x1 - 0, 2) + Math.pow(y1 - p.fire.length, 2));

            for (var i = 0; i < p.embers.length; i++) {
							p.stroke(128, 0, 0);
							p.fill(128, 0, 0);
							p.rect(x + p.pixelSize * p.embers[i].x, h - (p.embers[i].y + 1) * p.pixelSize, p.pixelSize, p.pixelSize);
						}

						for (var i = 0; i < p.fire.length; i++) {
							for (var j = 0; j < p.fire[i].length; j++) {
								var r = p.fire[i][j].r - Math.abs(x + p.pixelSize * j - w / 2) / 7;
								if (r > 10) {
									var dist = Math.sqrt(Math.pow(x1 - j, 2) + Math.pow(y1 - i, 2)) / maxDist;
									//p.stroke(0, 0, 0);
									p.stroke(r, r * dist, p.fire[i][j].b);
									p.fill(r, r * dist, p.fire[i][j].b);
									p.rect(x + p.pixelSize * j, h - (i + 1) * p.pixelSize, p.pixelSize, p.pixelSize);
								}
							}
						}

						// For good measure right now
						p.stroke(255, 0, 255);
						p.fill(255, 0, 255);
						p.line(w / 2, 0, w / 2, h);
					}

					p.resize = function() {
						p.size(canvas.width, canvas.height);

						p.fire = [];
						p.perlinTimer += 1;
						for (var i = 0; i < canvas.height / p.pixelSize * 2 / 3; i++) {
							p.fire.push([]);
							for (var j = 0; j < canvas.width / p.pixelSize; j++) {
								var pixel = {
									//r: Math.floor(Math.random() * (127 + 1)) + 127 * p.noise(j, i),
									r: 255 * p.noise(j * 0.3, i * 0.3, p.perlinTimer) - i * 7,
									g: 0,
									b: 0,
									//g: Math.floor(Math.random() * (50 + 1)),
									//b: Math.floor(Math.random() * (50 + 1)),
								};
								p.fire[i].push(pixel);
							}
						}
					}

					p.updateFire = function() {
						// Update embers
						for (var i = p.embers.length - 1; i >= 0; i--) {
							if (p.embers[i].t > 10) {
								p.embers[i].y += 1;
							}

							p.embers[i].t += 1;

							if (p.embers[i].y > canvas.height / p.pixelSize) {
								// Remove it
								p.embers.splice(i, 1)
							}
						}

            p.emberTimer += 1;
            if (p.emberTimer > 5) {
              p.emberTimer = 0;
              var x = Math.floor(Math.random() * (p.fire[0].length));
              for (var i = 0; i < p.fire.length; i++) {
                if (p.fire[i][x].r + p.fire[i][x].g + p.fire[i][x].b > 50) {
                  // Maybe make a few embers
                  var ember = {
                    x: x,
                    y: i,
                    t: 10,
                  };
                  p.embers.push(ember);
                  break;
                }
              }
            }
					}
				}

				var p = new Processing(canvas, sketch);

				$(window).resize(function() {
					canvas.width = window.innerWidth;
					canvas.height = window.innerHeight;

					p.resize();
				});
			});
		</script>
	</head>
	<body>
		<canvas id="fire"></canvas>
	</body>
</html>
